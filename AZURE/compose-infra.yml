name: MEGSI_ITI
services:
    traefik:
      image: traefik:latest
      command:
        - "--providers.docker=true"
        - "--providers.docker.exposedbydefault=false"
        - "--entrypoints.web.address=:80"
        - "--api.dashboard=true"
        - "--api.insecure=true"
        - "--metrics.prometheus=true"
        - "--metrics.prometheus.addrouterslabels=true"
        - "--metrics.prometheus.addserviceslabels=true"        
      ports:
        - "80:80"
        - "8080:8080"
      volumes:
        - /var/run/docker.sock:/var/run/docker.sock:ro
      networks:
        - megsi-net
        - traefik-net
      restart: always

    cadvisor:
      image: gcr.io/cadvisor/cadvisor:v0.49.1
      networks:
          - megsi-net
      volumes:
        - /:/rootfs:ro
        - /var/run:/var/run:ro
        - /sys:/sys:ro
        - /var/lib/docker:/var/lib/docker:ro
      ports:
        - "8081:8080"
      restart: always

    prometheus:
      container_name: prometheus
      image: prom/prometheus
      volumes:
        - /etc/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      ports:
        - "9090:9090"
      restart: always
      networks:
        - megsi-net

    kafka:
        container_name: kafka
        networks:
            - megsi-net
        ports:
            - 9092:9092
        environment:
            - KAFKA_PROCESS_ROLES=broker,controller
            - KAFKA_NODE_ID=1
            - KAFKA_CLUSTER_ID=5L6g3nShT-eMCtK--X86sw
            - KAFKA_CONTROLLER_QUORUM_VOTERS=1@kafka:9093
            - KAFKA_LISTENERS=PLAINTEXT://:9092,INTERNAL://:29092,CONTROLLER://:9093
            - KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://localhost:9092,INTERNAL://kafka:29092
            - KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=PLAINTEXT:PLAINTEXT,INTERNAL:PLAINTEXT,CONTROLLER:PLAINTEXT
            - KAFKA_CONTROLLER_LISTENER_NAMES=CONTROLLER
            - KAFKA_INTER_BROKER_LISTENER_NAME=INTERNAL
        image: apache/kafka:latest

    mariadb:
        container_name: mariadb
        networks:
            - megsi-net
        ports:
            - 3306:3306
        environment:
            - MARIADB_ROOT_PASSWORD=uminho
        image: mariadb:latest
        volumes:
            - mariadb-data:/var/lib/mysql

networks:
    megsi-net:
        external: true
        name: megsi-net
    traefik-net:
        external: true
        name: traefik-net
volumes:
    mariadb-data:
