name: ITI-INFRASTRUCTURE

services:
    megsi-config-server-fs:
        container_name: megsi-config-server
        networks:
            - megsi-net
        ports:
            - 8888:8888
        volumes:
            - /srv/configuration-server-fs:/srv/configuration-server-fs
        image: rafaelrpsantos/megsi-config-server-fs:latest
        healthcheck:
          test: ["CMD-SHELL", "wget -qO- http://localhost:8888/actuator/health | grep -q '\"status\":\"UP\"'"]
          interval: 10s
          timeout: 5s
          retries: 12
          start_period: 30s

    kafka:
        container_name: kafka
        networks:
            - megsi-net
        ports:
            - 9092:9092
        environment:
            - KAFKA_PROCESS_ROLES=broker,controller
            - KAFKA_NODE_ID=1
            - KAFKA_CLUSTER_ID=5L6g3nShT-eMCtK--X86sw
            - KAFKA_CONTROLLER_QUORUM_VOTERS=1@kafka:9093
            - KAFKA_LISTENERS=PLAINTEXT://:9092,INTERNAL://:29092,CONTROLLER://:9093
            - KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://localhost:9092,INTERNAL://kafka:29092
            - KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=PLAINTEXT:PLAINTEXT,INTERNAL:PLAINTEXT,CONTROLLER:PLAINTEXT
            - KAFKA_CONTROLLER_LISTENER_NAMES=CONTROLLER
            - KAFKA_INTER_BROKER_LISTENER_NAME=INTERNAL
        image: apache/kafka:latest

    mariadb:
        container_name: mariadb
        networks:
            - megsi-net
        ports:
            - 3306:3306
        environment:
            - MARIADB_ROOT_PASSWORD=uminho
        image: mariadb:latest
        volumes:
            - mariadb-data:/var/lib/mysql

    traefik:
      image: traefik:latest
      command:
        - "--providers.docker=true"
        - "--providers.docker.exposedbydefault=false"
        - "--entrypoints.web.address=:80"
        - "--api.dashboard=true"
        - "--api.insecure=true"
        - "--metrics.prometheus=true"
        - "--metrics.prometheus.addrouterslabels=true"
        - "--metrics.prometheus.addserviceslabels=true"
      ports:
        - "80:80"
        - "8080:8080"
      volumes:
        - /var/run/docker.sock:/var/run/docker.sock:ro
      networks:
        - megsi-net
        - traefik-net
      restart: always

    cadvisor:
      image: gcr.io/cadvisor/cadvisor:v0.49.1
      volumes:
        - /:/rootfs:ro
        - /var/run:/var/run:ro
        - /sys:/sys:ro
        - /var/lib/docker:/var/lib/docker:ro
      ports:
        - "8081:8080"
      restart: always

    prometheus:
      container_name: prometheus
      image: prom/prometheus
      volumes:
        - /etc/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      ports:
        - "9090:9090"
      restart: always
      networks:
        - megsi-net
      depends_on:
          megsi-config-server-fs:
              condition: service_healthy

    megsi-autenticator:
        container_name: megsi-autenticador
        networks:
            - megsi-net
        ports:
            - 30000:8080
        environment:
            - SPRING_CLOUD_CONFIG_URI=http://megsi-config-server:8888
            - MARIADB_SERVER_URI=mariadb
            - MYSQL_ROOT_PASSWORD=uminho
            - KAFKA_SERVER_URI=kafka:29092
        image: rafaelrpsantos/megsi-autenticator:latest
        depends_on:
            megsi-config-server-fs:
                condition: service_healthy

    megsi-autoscaler:
      image: rafaelrpsantos/megsi-iti-autoscaler:latest
      container_name: megsi-autoscaler
      restart: always
      volumes:
        - /var/run/docker.sock:/var/run/docker.sock
      cpus: "0.5"
      mem_limit: 256M
      networks:
        - megsi-net
        - traefik-net
      environment:
        - RPS_UP=5

#.   Este serviço será iniciado pelo script dentro do container megsi-autoscaler
#    megsi-iti-service-files:
#      container_name: megsi-iti-service-files-1
#      image: rafaelrpsantos/megsi-iti-service-files:latest
#      networks:
#        - megsi-net
#        - traefik-net
#      environment:
#        - SPRING_CLOUD_CONFIG_URI=http://megsi-config-server:8888
#        - MARIADB_SERVER_URI=mariadb
#        - MYSQL_ROOT_PASSWORD=uminho
#        - KAFKA_SERVER_URI=kafka:29092
#      volumes:
#        - /Users/rafaelrolimprudentedossantos/work/studies/mestrado/ITI/UMDRIVEFILES:/mnt/NAS
#      labels:
#        - "traefik.enable=true"
#        - "traefik.http.routers.files.rule=Host(`files.localhost`)"
#        - "traefik.http.routers.files.entrypoints=web"
#        - "traefik.http.services.files.loadbalancer.server.port=8081"

networks:
  traefik-net:
    external: true
    name: traefik-net
  megsi-net:
    external: true
    name: megsi-net

volumes:
    mariadb-data: